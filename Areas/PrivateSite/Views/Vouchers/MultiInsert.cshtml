
@{
    ViewData["Title"] = "MultiInsert";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-lg-12">
            <div class="container-fluid">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title fw-semibold mb-4">Thêm nhiều mã <a href="@Url.Action("ArticleList","Article")">Reset Form</a></h5>
                        <div class="card">
                            <div class="card-body">
                                <a href="/examplefile/fileex_voucher.xlsx" download style="color:red;">Nhấn vào đây để tải file mẫu</a>
                                <div class="form-group">
                                    <input type="file" name="file" id="fileVoucher" class="form-control" />
                                </div>
                                <button id="btnSubmitFile" class="btn btn-primary mt-2" onclick="ListVoucherComfirm()">Tải file</button>
                            </div>
                        </div>
            </div>
        </div>
        <div class="col-lg-12 d-flex align-items-stretch">
            <div class="card w-100">
                <div class="card-body p-4">
                    <div class="row">
                        <div class="col-lg-6 col-md-6">
                            <h5 class="card-title fw-600 mb-4">Danh sách thêm</h5>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-post text-nowrap mb-0 align-middle">
                            <thead class="text-dark fs-4">
                                <tr>
                                    <th class="">
                                        <h6 class="fw-600 mb-0">STT</h6>
                                    </th>
                                    <th class="">
                                        <h6 class="fw-600 mb-0">Mã voucher</h6>
                                    </th>
                                    <th class="">
                                        <h6 class="fw-600 mb-0">Thời gian tạo</h6>
                                    </th>
                                    <th class="">
                                        <h6 class="fw-600 mb-0">Thời gian </h6>
                                    </th>
                                    <th class="">
                                        <h6 class="fw-600 mb-0">Số lần dùng </h6>
                                    </th>
                                    <th class="">
                                        <h6 class="fw-600 mb-0">Lệnh</h6>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="tbody_vouchersConfirm"></tbody>
                        </table>
                    </div>
                </div>
                <button class="btn btn-success" onclick="InsertConfirm()">Xác nhận thêm</button>
            </div>
        </div>
    </div>
</div>
<script>
    var listVoucherConfirm = [];

    function ListVoucherComfirm() {
        var fileInput = document.getElementById('fileVoucher');
        var file = fileInput.files[0];
        if (!file) {
            alert("Bạn chưa chọn file");
            return;
        }
        var formData = new FormData();
        formData.append('file', file);

        fetch('/api/vouchers/loadmultiinsert', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    listVoucherConfirm = data.data.$values;
                    var tbody_confirm = document.getElementById('tbody_vouchersConfirm');
                    tbody_confirm.innerHTML = '';
                    listVoucherConfirm.forEach((voucher, index) => {
                        var row = document.createElement('tr');
                        row.innerHTML = `
                        <td><h6 class="fw-600 mb-0">${index + 1}</h6></td>
                        <td><h6 class="fw-600 mb-1">${voucher.voucherCode}</h6></td>
                        <td><h6 class="fw-600 mb-1">${formatDateTime(voucher.createAt)}</h6></td>
                        <td><h6 class="fw-600 mb-1">${formatDateTime(voucher.endAt)}</h6></td>
                        <td><h6 class="fw-600 mb-1">${voucher.numberOfTimesEXE}</h6></td>
                        <td>
                            <button type="button" class="btn btn-danger" onclick="RemoveVoucher(${index})">Xóa</button>
                        </td>
                    `;
                        tbody_confirm.appendChild(row);
                    });
                } else {
                    alert(data.message);
                }
            })
            .catch(error => console.error('Error:', error));
    }
            function formatDateTime(isoString) {
                // Tạo đối tượng Date từ chuỗi thời gian ISO 8601
                var date = new Date(isoString);

                // Lấy các phần của ngày, tháng, năm, giờ, phút và giây
                var day = String(date.getDate()).padStart(2, '0');
                var month = String(date.getMonth() + 1).padStart(2, '0'); // Tháng bắt đầu từ 0
                var year = date.getFullYear();
                var hours = String(date.getHours()).padStart(2, '0');
                var minutes = String(date.getMinutes()).padStart(2, '0');
                var seconds = String(date.getSeconds()).padStart(2, '0');

                // Ghép các phần lại với nhau theo định dạng dd/MM/yyyy hh:mm:ss
                var formattedDateTime = `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;

                return formattedDateTime;
            }
       function RemoveVoucher(index){
            listVoucherConfirm.splice(index, 1);
           console.log(index);
            var tbody_confirm = document.getElementById('tbody_vouchersConfirm');
            tbody_confirm.deleteRow(index);
       }
    function InsertConfirm() {
        if(listVoucherConfirm.length>0){
            fetch('/api/vouchers/insertmulticonfirm', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(listVoucherConfirm)
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    if (data.success) {
                        alert("Đã thêm thành công");
                        // xóa bảng và danh sách
                        document.getElementById('tbody_vouchersConfirm').innerHTML = '';
                        listVoucherConfirm = [];
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("Error");
                });
        }else{
                    alert("Error");
        }
     
    }
</script>


